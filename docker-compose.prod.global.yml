# CRM Aetheria - Utilise le PostgreSQL GLOBAL existant (postgres_global)
# Pas de container Postgres dédié = une seule instance Postgres sur le VPS
# Traefik : crm.agenceaetheria.com → frontend, crm.agenceaetheria.com/api → backend

version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: aetheria_backend_prod
    restart: unless-stopped
    expose:
      - "8000"
    environment:
      DATABASE_URL: postgresql+asyncpg://${CRM_POSTGRES_USER}:${CRM_POSTGRES_PASSWORD}@postgres_global:5432/${CRM_POSTGRES_DB}
      SECRET_KEY: ${SECRET_KEY}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
    volumes:
      - ./data/uploads:/app/uploads
    networks:
      - postgres-global_default
      - n8n-stack_default
      - aetheria_network
    labels:
      - traefik.enable=true
      - traefik.http.routers.crm-api.rule=Host(`crm.agenceaetheria.com`) && PathPrefix(`/api`)
      - traefik.http.routers.crm-api.tls=true
      - traefik.http.routers.crm-api.entrypoints=websecure
      - traefik.http.routers.crm-api.tls.certresolver=mytlschallenge
      - traefik.http.routers.crm-api.middlewares=crm-stripprefix
      - traefik.http.middlewares.crm-stripprefix.stripprefix.prefixes=/api
      - traefik.http.services.crm-api.loadbalancer.server.port=8000

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    container_name: aetheria_frontend_prod
    restart: unless-stopped
    expose:
      - "3000"
    environment:
      NEXT_PUBLIC_API_URL: https://crm.agenceaetheria.com/api
    depends_on:
      - backend
    networks:
      - aetheria_network
      - n8n-stack_default
    labels:
      - traefik.enable=true
      - traefik.http.routers.crm.rule=Host(`crm.agenceaetheria.com`)
      - traefik.http.routers.crm.tls=true
      - traefik.http.routers.crm.entrypoints=websecure
      - traefik.http.routers.crm.tls.certresolver=mytlschallenge
      - traefik.http.services.crm.loadbalancer.server.port=3000

networks:
  postgres-global_default:
    external: true
  n8n-stack_default:
    external: true
  aetheria_network:
    driver: bridge
